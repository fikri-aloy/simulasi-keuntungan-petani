<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi - AgroProfit</title>
    <!-- CSS -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/component.css">
    <link rel="stylesheet" href="css/page.css">
    <link rel="stylesheet" href="css/responsive.css">
    <!-- jsPDF untuk export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS tambahan untuk format input dengan titik */
        .formatted-input {
            position: relative;
        }
        
        .formatted-input input {
            padding-right: 40px !important;
            letter-spacing: 0.5px;
        }
        
        .currency-symbol {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: #f8f9fa;
            padding: 8px 10px;
            border-radius: 4px;
            font-weight: bold;
            color: #28a745;
            z-index: 2;
        }
        
        .unit-symbol {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: #f8f9fa;
            padding: 8px 10px;
            border-radius: 4px;
            font-weight: bold;
            color: #495057;
            z-index: 2;
        }
        
        /* Perbaikan layout untuk input dengan icon */
        .input-with-icon {
            position: relative;
        }
        
        .input-with-icon i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 2;
        }
        
        .input-with-icon input {
            padding-left: 40px !important;
        }
        
        /* Perbaikan untuk unit toggle */
        .unit-toggle {
            display: flex;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-left: 10px;
            min-width: 100px;
        }
        
        .unit-btn {
            padding: 8px 12px !important;
            border: none;
            background: transparent;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .unit-btn.active {
            background: #28a745;
            color: white;
        }
        
        /* Spasi lebih untuk input number */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Perbaikan tata letak form */
        .form-grid {
            display: grid;
            gap: 20px;
        }
        
        .form-group {
            position: relative;
            margin-bottom: 15px;
        }
        
        /* Pastikan logo dan elemen navbar tidak tumpang tindih */
        .navbar {
            z-index: 1000;
            position: relative;
        }
        
        .container {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="dashboard.html" class="logo">
                <i class="fas fa-leaf"></i> AgroProfit
            </a>
            <div class="nav-links">
                <a href="dashboard.html">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="simulation.html" class="active">
                    <i class="fas fa-calculator"></i> Simulasi
                </a>
                <a href="#">
                    <i class="fas fa-history"></i> Riwayat
                </a>
                <div class="user-menu">
                    <span class="user-name" id="userName"></span>
                    <button class="btn-logout" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Keluar
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Simulasi Keuntungan Pertanian</h1>
            <p>Hitung perkiraan keuntungan usaha tani Anda dengan parameter lengkap</p>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Column: Input Form -->
            <div class="left-column">
                <!-- Input Form -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-edit"></i>
                        <h2>Input Data Pertanian</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <!-- Crop Type -->
                            <div class="form-group">
                                <label for="cropType">Jenis Tanaman</label>
                                <select id="cropType">
                                    <option value="padi">Padi Sawah</option>
                                    <option value="jagung">Jagung</option>
                                    <option value="kedelai">Kedelai</option>
                                    <option value="cabe">Cabe Merah</option>
                                    <option value="tomat">Tomat</option>
                                    <option value="bawang">Bawang Merah</option>
                                </select>
                            </div>
                            
                            <!-- Land Area -->
                            <div class="form-group">
                                <label for="landArea">Luas Lahan</label>
                                <div class="input-with-unit" style="display: flex; align-items: center;">
                                    <div class="formatted-input" style="flex: 1; position: relative;">
                                        <input type="text" id="landArea" value="1" placeholder="Contoh: 1,5">
                                        <span class="unit-symbol" id="areaUnitDisplay">Ha</span>
                                    </div>
                                    <div class="unit-toggle">
                                        <button type="button" class="unit-btn active" data-unit="hektar">Hektar</button>
                                        <button type="button" class="unit-btn" data-unit="meter">m¬≤</button>
                                    </div>
                                </div>
                                <input type="hidden" id="unit" value="hektar">
                            </div>
                            
                            <!-- Seed Cost -->
                            <div class="form-group">
                                <label for="seedCost">Biaya Bibit (Rp)</label>
                                <div class="formatted-input">
                                    <input type="text" id="seedCost" value="2.000.000" placeholder="Contoh: 2.000.000">
                                    <span class="currency-symbol">Rp</span>
                                </div>
                            </div>
                            
                            <!-- Fertilizer Cost -->
                            <div class="form-group">
                                <label for="fertilizerCost">Biaya Pupuk & Pestisida (Rp)</label>
                                <div class="formatted-input">
                                    <input type="text" id="fertilizerCost" value="1.500.000" placeholder="Contoh: 1.500.000">
                                    <span class="currency-symbol">Rp</span>
                                </div>
                            </div>
                            
                            <!-- Labor Cost -->
                            <div class="form-group">
                                <label for="laborCost">Biaya Tenaga Kerja (Rp)</label>
                                <div class="formatted-input">
                                    <input type="text" id="laborCost" value="3.000.000" placeholder="Contoh: 3.000.000">
                                    <span class="currency-symbol">Rp</span>
                                </div>
                            </div>
                            
                            <!-- Estimated Harvest -->
                            <div class="form-group">
                                <label for="estimatedHarvest">Estimasi Hasil Panen (kg)</label>
                                <div class="formatted-input">
                                    <input type="text" id="estimatedHarvest" value="6.000" placeholder="Contoh: 6.000">
                                    <span class="unit-symbol">kg</span>
                                </div>
                            </div>
                            
                            <!-- Price per kg -->
                            <div class="form-group">
                                <label for="pricePerKg">Harga Jual per kg (Rp)</label>
                                <div class="formatted-input">
                                    <input type="text" id="pricePerKg" value="5.000" placeholder="Contoh: 5.000">
                                    <span class="currency-symbol">Rp</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Calculate Button -->
                        <button id="calculateBtn" class="btn btn-primary btn-block">
                            <i class="fas fa-calculator"></i> Hitung Simulasi
                        </button>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="card" id="resultsCard" style="display: none;">
                    <div class="card-header">
                        <i class="fas fa-chart-bar"></i>
                        <h2>Hasil Simulasi</h2>
                    </div>
                    <div class="card-body">
                        <!-- Results Grid -->
                        <div class="results-grid">
                            <div class="result-card total-cost">
                                <h3>Total Modal</h3>
                                <div class="result-value" id="totalCost">Rp 0</div>
                            </div>
                            
                            <div class="result-card total-revenue">
                                <h3>Total Pendapatan</h3>
                                <div class="result-value" id="totalRevenue">Rp 0</div>
                            </div>
                            
                            <div class="result-card profit">
                                <h3>Keuntungan</h3>
                                <div class="result-value" id="profit">Rp 0</div>
                            </div>
                            
                            <div class="result-card roi">
                                <h3>ROI</h3>
                                <div class="result-value" id="roi">0%</div>
                            </div>
                        </div>
                        
                        <!-- Chart Placeholder -->
                        <div class="chart-container">
                            <h3>Visualisasi Hasil</h3>
                            <div id="profitChart" class="chart">
                                <!-- Chart will be generated here -->
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button id="saveSimulationBtn" class="btn btn-primary">
                                <i class="fas fa-save"></i> Simpan Simulasi
                            </button>
                            <button id="exportPdfBtn" class="btn btn-outline" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                            <button id="resetBtn" class="btn btn-outline">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Sidebar -->
            <div class="right-column">
                <!-- User Info -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-user"></i>
                        <h2>Info Akun</h2>
                    </div>
                    <div class="card-body">
                        <div class="user-info">
                            <div class="user-avatar">
                                <span id="userInitials">P</span>
                            </div>
                            <div class="user-details">
                                <h3 id="sidebarUserName">Petani</h3>
                                <p><i class="fas fa-star"></i> <span id="sidebarUserPoints">0</span> Poin</p>
                                <p><i class="fas fa-calculator"></i> <span id="sidebarUserSimulations">0</span> Simulasi</p>
                                <p><i class="fas fa-chart-line"></i> Level <span id="sidebarUserLevel">1</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Farming Tips -->
                <div class="card tips-card">
                    <div class="card-header">
                        <i class="fas fa-lightbulb"></i>
                        <h2>Tips Pertanian</h2>
                    </div>
                    <div class="card-body">
                        <ul class="tips-list">
                            <li>Gunakan benih bersertifikat untuk hasil optimal</li>
                            <li>Pupuk organik meningkatkan kesuburan tanah jangka panjang</li>
                            <li>Rotasi tanaman mencegah penumpukan hama</li>
                            <li>Pantau harga pasar sebelum menentukan harga jual</li>
                            <li>Faktor cuaca dan musim mempengaruhi hasil panen</li>
                            <li>Selalu siapkan dana cadangan untuk keadaan darurat</li>
                        </ul>
                    </div>
                </div>

                <!-- Gamification Info -->
                <div class="card gamification-card">
                    <div class="card-header">
                        <i class="fas fa-trophy"></i>
                        <h2>Sistem Poin</h2>
                    </div>
                    <div class="card-body">
                        <div class="points-info">
                            <div class="points-value">+10</div>
                            <p>Poin setiap simulasi yang disimpan</p>
                        </div>
                        
                        <h3>Badges yang Tersedia:</h3>
                        <div class="badges-list">
                            <div class="badge-item">
                                <span class="badge-icon">üå±</span>
                                <div class="badge-info">
                                    <strong>Pemula</strong>
                                    <small>5 simulasi</small>
                                </div>
                            </div>
                            <div class="badge-item">
                                <span class="badge-icon">üåæ</span>
                                <div class="badge-info">
                                    <strong>Petani Hebat</strong>
                                    <small>15 simulasi</small>
                                </div>
                            </div>
                            <div class="badge-item">
                                <span class="badge-icon">üèÜ</span>
                                <div class="badge-info">
                                    <strong>Master Panen</strong>
                                    <small>50 simulasi</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/db.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/calculator.js"></script>
    <script src="js/main.js"></script>
    
    <script>
        // Gunakan instance dari auth.js
        let authSystem = window.Auth;
        
        // Jika belum ada, buat instance baru
        if (!authSystem && typeof AuthSystem !== 'undefined') {
            authSystem = new AuthSystem();
            window.Auth = authSystem;
        }
        
        // Cek calculator
        let calculator = window.ProfitCalculator || window.calculator;
        if (!calculator && typeof ProfitCalculator !== 'undefined') {
            calculator = new ProfitCalculator();
        }
        
        let currentUser = null;
        let currentCalculation = null;
        
        // Fungsi untuk memformat angka dengan titik
        function formatNumberInput(input) {
            // Hapus semua karakter selain angka dan koma
            let value = input.value.replace(/[^\d,]/g, '');
            
            // Ganti koma dengan titik untuk ribuan
            value = value.replace(/\./g, '');
            value = value.replace(/,/g, '.');
            
            // Format dengan titik setiap 3 digit dari belakang
            if (value.length > 3) {
                // Pisahkan bagian desimal jika ada
                let parts = value.split('.');
                let integerPart = parts[0];
                let decimalPart = parts.length > 1 ? '.' + parts[1] : '';
                
                // Format bagian integer dengan titik
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                value = integerPart + decimalPart;
            }
            
            // Update nilai input
            input.value = value;
        }
        
        // Fungsi untuk mengubah string format angka menjadi angka murni
        function parseNumber(str) {
            if (!str) return 0;
            // Hapus semua titik dan ganti koma dengan titik untuk desimal
            let cleanStr = str.toString().replace(/\./g, '').replace(',', '.');
            return parseFloat(cleanStr) || 0;
        }
        
        // Fungsi untuk memformat angka ke string dengan titik
        function formatNumber(num) {
            if (!num && num !== 0) return '0';
            let parts = num.toString().split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return parts.join(',');
        }
        
        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Simulation page loaded');
            
            // Cek authSystem
            if (!authSystem) {
                console.error('AuthSystem tidak ditemukan!');
                alert('Sistem autentikasi tidak tersedia. Redirect ke login...');
                window.location.href = 'login.html';
                return;
            }
            
            // Check authentication
            if (authSystem.requireAuth && !authSystem.requireAuth()) {
                window.location.href = 'login.html';
                return;
            }
            
            // Get current user
            currentUser = authSystem.getCurrentUser ? authSystem.getCurrentUser() : null;
            
            if (!currentUser) {
                console.log('User tidak ditemukan, redirect ke login');
                window.location.href = 'login.html';
                return;
            }
            
            // Update user info
            updateUserInfo();
            
            // Initialize form dengan format titik
            initializeForm();
            
            // Setup event listeners
            setupEventListeners();
            
            // Tambahkan event listener untuk format otomatis
            setupFormattingListeners();
        });
        
        // Setup event listeners untuk format otomatis
        function setupFormattingListeners() {
            const formatInputs = [
                'seedCost', 'fertilizerCost', 'laborCost', 
                'estimatedHarvest', 'pricePerKg', 'landArea'
            ];
            
            formatInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    // Format saat input berubah
                    input.addEventListener('input', function() {
                        formatNumberInput(this);
                    });
                    
                    // Format saat kehilangan fokus
                    input.addEventListener('blur', function() {
                        formatNumberInput(this);
                    });
                    
                    // Format saat halaman dimuat
                    formatNumberInput(input);
                }
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Calculate button
            const calculateBtn = document.getElementById('calculateBtn');
            if (calculateBtn) {
                calculateBtn.addEventListener('click', calculateSimulation);
            }
            
            // Save button
            const saveBtn = document.getElementById('saveSimulationBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveSimulation);
            }
            
            // Reset button
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetForm);
            }
            
            // Export PDF button sudah pakai onclick langsung
            
            // Crop type change
            const cropSelect = document.getElementById('cropType');
            if (cropSelect) {
                cropSelect.addEventListener('change', updateCropDefaults);
            }
            
            // Unit toggle buttons
            const unitButtons = document.querySelectorAll('.unit-btn');
            unitButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    unitButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('unit').value = this.dataset.unit;
                    
                    // Update unit display
                    const areaUnitDisplay = document.getElementById('areaUnitDisplay');
                    if (areaUnitDisplay) {
                        areaUnitDisplay.textContent = this.dataset.unit === 'hektar' ? 'Ha' : 'm¬≤';
                    }
                    
                    if (currentCalculation) {
                        calculateSimulation();
                    }
                });
            });
        }
        
        // Initialize form
        function initializeForm() {
            // Set user avatar initials
            if (currentUser && currentUser.name) {
                const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                const userInitials = document.getElementById('userInitials');
                if (userInitials) userInitials.textContent = initials;
            }
            
            // Initialize crop defaults
            updateCropDefaults();
        }
        
        // Update user info
        function updateUserInfo() {
            if (!currentUser) return;
            
            // Navbar user name
            const userNameElement = document.getElementById('userName');
            if (userNameElement) userNameElement.textContent = currentUser.name;
            
            // Sidebar user info
            const sidebarUserName = document.getElementById('sidebarUserName');
            const sidebarUserPoints = document.getElementById('sidebarUserPoints');
            const sidebarUserSimulations = document.getElementById('sidebarUserSimulations');
            const sidebarUserLevel = document.getElementById('sidebarUserLevel');
            
            if (sidebarUserName) sidebarUserName.textContent = currentUser.name;
            if (sidebarUserPoints) sidebarUserPoints.textContent = formatNumber(currentUser.points || 0);
            if (sidebarUserSimulations) sidebarUserSimulations.textContent = formatNumber(currentUser.simulationsCount || 0);
            if (sidebarUserLevel) sidebarUserLevel.textContent = formatNumber(currentUser.level || 1);
        }
        
        // Update crop defaults
        function updateCropDefaults() {
            const cropType = document.getElementById('cropType').value;
            
            if (calculator && calculator.getCropDefaults) {
                const cropData = calculator.getCropDefaults(cropType);
                
                if (cropData) {
                    const harvestInput = document.getElementById('estimatedHarvest');
                    const priceInput = document.getElementById('pricePerKg');
                    
                    if (harvestInput) {
                        harvestInput.value = formatNumber(cropData.harvest || 6000);
                        formatNumberInput(harvestInput);
                    }
                    if (priceInput) {
                        priceInput.value = formatNumber(cropData.price || 5000);
                        formatNumberInput(priceInput);
                    }
                }
            }
        }
        
        // Calculate simulation
        function calculateSimulation() {
            try {
                // Get form values dengan parsing angka berformat
                const formData = {
                    cropType: document.getElementById('cropType').value,
                    landArea: parseNumber(document.getElementById('landArea').value) || 1,
                    unit: document.getElementById('unit').value,
                    seedCost: parseNumber(document.getElementById('seedCost').value) || 0,
                    fertilizerCost: parseNumber(document.getElementById('fertilizerCost').value) || 0,
                    laborCost: parseNumber(document.getElementById('laborCost').value) || 0,
                    estimatedHarvest: parseNumber(document.getElementById('estimatedHarvest').value) || 0,
                    pricePerKg: parseNumber(document.getElementById('pricePerKg').value) || 0
                };
                
                if (formData.landArea <= 0) {
                    alert('Luas lahan harus lebih dari 0');
                    return;
                }
                
                if (!calculator || typeof calculator.calculate !== 'function') {
                    alert('Kalkulator tidak tersedia!');
                    return;
                }
                
                currentCalculation = calculator.calculate(formData);
                displayResults(currentCalculation);
                
            } catch (error) {
                console.error('Calculation error:', error);
                alert('Terjadi kesalahan saat menghitung: ' + error.message);
            }
        }
        
        // Display results
        function displayResults(result) {
            const formatCurrency = (amount) => {
                return 'Rp ' + formatNumber(amount);
            };
            
            const totalCostElement = document.getElementById('totalCost');
            const totalRevenueElement = document.getElementById('totalRevenue');
            const profitElement = document.getElementById('profit');
            const roiElement = document.getElementById('roi');
            
            if (totalCostElement) totalCostElement.textContent = formatCurrency(result.totalCost);
            if (totalRevenueElement) totalRevenueElement.textContent = formatCurrency(result.totalRevenue);
            if (profitElement) {
                profitElement.textContent = formatCurrency(result.profit);
                profitElement.className = result.profit >= 0 ? 'result-value profit' : 'result-value loss';
            }
            if (roiElement) {
                roiElement.textContent = result.roi + '%';
                roiElement.className = result.roi >= 0 ? 'result-value profit' : 'result-value loss';
            }
            
            const resultsCard = document.getElementById('resultsCard');
            if (resultsCard) resultsCard.style.display = 'block';
            
            createChart(result);
        }
        
        // Create simple chart
        function createChart(result) {
            const chartContainer = document.getElementById('profitChart');
            if (!chartContainer) return;
            
            const chartData = [
                { label: 'Total Modal', value: result.totalCost, color: '#ef4444' },
                { label: 'Total Pendapatan', value: result.totalRevenue, color: '#10b981' },
                { label: 'Keuntungan', value: result.profit, color: result.profit >= 0 ? '#059669' : '#dc2626' }
            ];
            
            const maxValue = Math.max(...chartData.map(d => Math.abs(d.value)));
            
            let chartHTML = '<div class="chart-bars">';
            
            chartData.forEach(data => {
                const percentage = maxValue > 0 ? (Math.abs(data.value) / maxValue) * 100 : 0;
                chartHTML += `
                    <div class="chart-item">
                        <div class="chart-label">
                            <span class="chart-color" style="background: ${data.color}"></span>
                            <span>${data.label}</span>
                        </div>
                        <div class="chart-bar-container">
                            <div class="chart-bar" style="width: ${percentage}%; background: ${data.color}"></div>
                            <span class="chart-value">Rp ${formatNumber(Math.abs(data.value))}</span>
                        </div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }
        
        // Save simulation
        function saveSimulation() {
            if (!currentCalculation || !currentUser) {
                alert('Harap hitung simulasi terlebih dahulu!');
                return;
            }
            
            const db = window.AgroDB || window.db;
            
            if (!db || typeof db.addSimulation !== 'function') {
                alert('Database tidak tersedia. Tidak dapat menyimpan simulasi.');
                return;
            }
            
            const simulationData = {
                ...currentCalculation,
                userId: currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            const saved = db.addSimulation(simulationData);
            
            if (!saved) {
                alert('Gagal menyimpan simulasi.');
                return;
            }
            
            if (db.updateUserPoints && typeof db.updateUserPoints === 'function') {
                db.updateUserPoints(currentUser.id, 10);
            }
            
            currentUser = authSystem.getCurrentUser ? authSystem.getCurrentUser() : currentUser;
            updateUserInfo();
            
            alert('‚úÖ Simulasi berhasil disimpan! +10 Poin');
            
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 2000);
        }
        
        // ===== PDF EXPORT FUNCTION =====
        function exportToPDF() {
            if (!currentCalculation) {
                alert('Harap hitung simulasi terlebih dahulu!');
                return;
            }
            
            // Cek apakah jsPDF tersedia
            if (typeof window.jspdf === 'undefined') {
                alert('Sistem export PDF belum siap. Silakan refresh halaman.');
                console.error('jsPDF not loaded');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Judul
                doc.setFontSize(20);
                doc.setTextColor(40, 180, 99);
                doc.text('AgroProfit', 105, 20, { align: 'center' });
                
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('HASIL SIMULASI PERTANIAN', 105, 30, { align: 'center' });
                
                // Garis pemisah
                doc.setDrawColor(200, 200, 200);
                doc.line(20, 35, 190, 35);
                
                // Info pengguna
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                if (currentUser) {
                    doc.text(`Nama: ${currentUser.name}`, 20, 45);
                    doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 20, 50);
                }
                
                // Data input
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('DATA INPUT:', 20, 65);
                
                doc.setFontSize(10);
                let y = 72;
                
                const cropNames = {
                    'padi': 'Padi Sawah', 'jagung': 'Jagung', 'kedelai': 'Kedelai',
                    'cabe': 'Cabe Merah', 'tomat': 'Tomat', 'bawang': 'Bawang Merah'
                };
                
                const inputData = [
                    ['Jenis Tanaman', cropNames[document.getElementById('cropType').value] || 'Tanaman'],
                    ['Luas Lahan', `${document.getElementById('landArea').value} ${document.getElementById('unit').value === 'meter' ? 'm¬≤' : 'Hektar'}`],
                    ['Biaya Bibit', formatCurrencyForPDF(parseNumber(document.getElementById('seedCost').value) || 0)],
                    ['Biaya Pupuk', formatCurrencyForPDF(parseNumber(document.getElementById('fertilizerCost').value) || 0)],
                    ['Biaya Tenaga Kerja', formatCurrencyForPDF(parseNumber(document.getElementById('laborCost').value) || 0)],
                    ['Estimasi Panen', `${document.getElementById('estimatedHarvest').value} kg`],
                    ['Harga per kg', formatCurrencyForPDF(parseNumber(document.getElementById('pricePerKg').value) || 0)]
                ];
                
                inputData.forEach(([label, value]) => {
                    doc.text(`${label}:`, 25, y);
                    doc.text(value, 80, y);
                    y += 6;
                });
                
                // Hasil simulasi
                y += 10;
                doc.setFontSize(14);
                doc.text('HASIL SIMULASI:', 20, y);
                
                y += 10;
                doc.setFontSize(12);
                
                const results = [
                    ['Total Modal', formatCurrencyForPDF(currentCalculation.totalCost)],
                    ['Total Pendapatan', formatCurrencyForPDF(currentCalculation.totalRevenue)],
                    ['Keuntungan', formatCurrencyForPDF(currentCalculation.profit), currentCalculation.profit >= 0 ? [46, 125, 50] : [198, 40, 40]],
                    ['ROI', `${currentCalculation.roi}%`, currentCalculation.roi >= 0 ? [46, 125, 50] : [198, 40, 40]]
                ];
                
                results.forEach(([label, value, color]) => {
                    if (color) {
                        doc.setTextColor(color[0], color[1], color[2]);
                    } else {
                        doc.setTextColor(0, 0, 0);
                    }
                    
                    doc.text(`${label}:`, 25, y);
                    doc.text(value, 80, y);
                    y += 8;
                });
                
                // Analisis
                y += 10;
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('ANALISIS:', 20, y);
                
                y += 10;
                doc.setFontSize(10);
                
                let analysis = '';
                if (currentCalculation.profit > 0) {
                    if (currentCalculation.roi > 50) {
                        analysis = 'Hasil simulasi menunjukkan keuntungan yang SANGAT BAIK dengan ROI di atas 50%. Disarankan untuk melanjutkan rencana ini.';
                    } else if (currentCalculation.roi > 20) {
                        analysis = 'Hasil simulasi menunjukkan keuntungan yang BAIK dengan ROI 20-50%. Usaha ini layak dijalankan.';
                    } else {
                        analysis = 'Hasil simulasi menunjukkan keuntungan MODERAT. Pertimbangkan optimasi biaya untuk meningkatkan ROI.';
                    }
                } else {
                    analysis = 'Hasil simulasi menunjukkan KERUGIAN. Disarankan untuk: 1) Meninjau biaya produksi, 2) Mencari pemasok lebih murah, 3) Pertimbangkan tanaman lain.';
                }
                
                // Split text agar tidak keluar halaman
                const lines = doc.splitTextToSize(analysis, 160);
                lines.forEach(line => {
                    doc.text(line, 25, y);
                    y += 6;
                });
                
                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('¬© ' + new Date().getFullYear() + ' AgroProfit - www.agroprofit.example.com', 105, 285, { align: 'center' });
                
                // Simpan PDF
                const cropType = document.getElementById('cropType').value;
                const filename = `Simulasi_${cropNames[cropType] || 'Pertanian'}_${new Date().getTime()}.pdf`;
                doc.save(filename);
                
                alert(`‚úÖ PDF berhasil diexport: ${filename}`);
                console.log('PDF exported:', filename);
                
            } catch (error) {
                console.error('Export PDF error:', error);
                alert('‚ùå Gagal mengexport PDF: ' + error.message);
            }
        }
        
        // Helper function untuk format mata uang di PDF
        function formatCurrencyForPDF(amount) {
            return 'Rp ' + formatNumber(amount);
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('landArea').value = '1';
            document.getElementById('seedCost').value = '2.000.000';
            document.getElementById('fertilizerCost').value = '1.500.000';
            document.getElementById('laborCost').value = '3.000.000';
            document.getElementById('estimatedHarvest').value = '6.000';
            document.getElementById('pricePerKg').value = '5.000';
            
            document.querySelectorAll('.unit-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.unit === 'hektar') {
                    btn.classList.add('active');
                }
            });
            
            document.getElementById('unit').value = 'hektar';
            
            // Update unit display
            const areaUnitDisplay = document.getElementById('areaUnitDisplay');
            if (areaUnitDisplay) areaUnitDisplay.textContent = 'Ha';
            
            const resultsCard = document.getElementById('resultsCard');
            if (resultsCard) resultsCard.style.display = 'none';
            
            currentCalculation = null;
            updateCropDefaults();
            
            alert('Form telah direset ke nilai default.');
        }
        
        // Logout function
        function logout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                if (authSystem && typeof authSystem.logout === 'function') {
                    authSystem.logout();
                }
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 500);
            }
        }
        
        // Ekspor fungsi ke window
        window.exportToPDF = exportToPDF;
        window.logout = logout;
    </script>
</body>
</html>